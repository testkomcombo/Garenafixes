name: Windows-RDP-Kaggle-GPU

on:
  workflow_dispatch:

jobs:
  windows-rdp:
    runs-on: windows-latest
    timeout-minutes: 3600

    steps:
      - name: System Info
        run: |
          Write-Host "=== OS Info ===" -ForegroundColor Cyan
          Get-ComputerInfo | Select-Object WindowsProductName, WindowsVersion, OsBuildNumber | Format-List

      - name: Configure RDP Settings
        run: |
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "SecurityLayer" -Value 0 -Force
          
          netsh advfirewall firewall delete rule name="RDP-Tailscale" 2>$null
          netsh advfirewall firewall add rule name="RDP-Tailscale" dir=in action=allow protocol=TCP localport=3389
          netsh advfirewall firewall add rule name="RDP-UDP" dir=in action=allow protocol=UDP localport=3389
          
          Restart-Service -Name TermService -Force

      - name: Optimize RDP (120 FPS)
        run: |
          $tsPath = 'HKLM:\SOFTWARE\Policies\Microsoft\Windows NT\Terminal Services'
          $rdpTcpPath = 'HKLM:\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp'
          
          New-Item -Path $tsPath -Force -ErrorAction SilentlyContinue | Out-Null
          
          New-ItemProperty -Path $rdpTcpPath -Name "MaxFrameRate" -Value 120 -PropertyType DWord -Force -ErrorAction SilentlyContinue
          New-ItemProperty -Path $tsPath -Name "MaxFrameRate" -Value 120 -PropertyType DWord -Force -ErrorAction SilentlyContinue
          New-ItemProperty -Path $tsPath -Name "SelectTransport" -Value 0 -PropertyType DWord -Force -ErrorAction SilentlyContinue
          New-ItemProperty -Path $tsPath -Name "AVCHardwareEncodePreferred" -Value 1 -PropertyType DWord -Force -ErrorAction SilentlyContinue
          New-ItemProperty -Path $tsPath -Name "AVC444ModePreferred" -Value 1 -PropertyType DWord -Force -ErrorAction SilentlyContinue
          Set-ItemProperty -Path 'HKLM:\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations' -Name "ThrottleEnabled" -Value 0 -Force -ErrorAction SilentlyContinue
          New-ItemProperty -Path $rdpTcpPath -Name "ColorDepth" -Value 5 -PropertyType DWord -Force -ErrorAction SilentlyContinue
          New-ItemProperty -Path $tsPath -Name "fNoRemoteDesktopWallpaper" -Value 0 -PropertyType DWord -Force -ErrorAction SilentlyContinue
          New-ItemProperty -Path $tsPath -Name "fAllowDesktopCompositionOnServer" -Value 1 -PropertyType DWord -Force -ErrorAction SilentlyContinue

      - name: Optimize Network
        run: |
          netsh interface tcp set global autotuninglevel=experimental
          netsh interface tcp set global congestionprovider=ctcp
          netsh interface tcp set global ecncapability=enabled
          netsh interface tcp set global rss=enabled
          netsh interface tcp set global fastopen=enabled
          
          $tcpPath = 'HKLM:\SYSTEM\CurrentControlSet\Services\Tcpip\Parameters'
          New-ItemProperty -Path $tcpPath -Name "TcpAckFrequency" -Value 1 -PropertyType DWord -Force -ErrorAction SilentlyContinue
          New-ItemProperty -Path $tcpPath -Name "TCPNoDelay" -Value 1 -PropertyType DWord -Force -ErrorAction SilentlyContinue

      - name: Enable Dark Theme
        run: |
          reg load HKU\DefaultUser "C:\Users\Default\NTUSER.DAT"
          
          reg add "HKU\DefaultUser\SOFTWARE\Microsoft\Windows\CurrentVersion\Themes\Personalize" /v AppsUseLightTheme /t REG_DWORD /d 0 /f
          reg add "HKU\DefaultUser\SOFTWARE\Microsoft\Windows\CurrentVersion\Themes\Personalize" /v SystemUsesLightTheme /t REG_DWORD /d 0 /f
          reg add "HKU\DefaultUser\SOFTWARE\Microsoft\Windows\CurrentVersion\Themes\Personalize" /v EnableTransparency /t REG_DWORD /d 1 /f
          reg add "HKU\DefaultUser\SOFTWARE\Microsoft\Windows\CurrentVersion\Themes\Personalize" /v ColorPrevalence /t REG_DWORD /d 1 /f
          reg add "HKU\DefaultUser\Control Panel\Colors" /v Background /t REG_SZ /d "30 30 30" /f
          
          [gc]::Collect()
          Start-Sleep -Seconds 2
          reg unload HKU\DefaultUser
          
          reg add "HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Themes\Personalize" /v AppsUseLightTheme /t REG_DWORD /d 0 /f
          reg add "HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Themes\Personalize" /v SystemUsesLightTheme /t REG_DWORD /d 0 /f

      - name: Enable All Animations
        run: |
          reg load HKU\DefaultUser "C:\Users\Default\NTUSER.DAT"
          
          reg add "HKU\DefaultUser\Software\Microsoft\Windows\CurrentVersion\Explorer\VisualEffects" /v VisualFXSetting /t REG_DWORD /d 1 /f
          reg add "HKU\DefaultUser\Control Panel\Desktop" /v FontSmoothing /t REG_SZ /d "2" /f
          reg add "HKU\DefaultUser\Control Panel\Desktop" /v FontSmoothingType /t REG_DWORD /d 2 /f
          reg add "HKU\DefaultUser\Control Panel\Desktop\WindowMetrics" /v MinAnimate /t REG_SZ /d "1" /f
          reg add "HKU\DefaultUser\Control Panel\Desktop" /v UserPreferencesMask /t REG_BINARY /d 9e3e078012000000 /f
          reg add "HKU\DefaultUser\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\Advanced" /v TaskbarAnimations /t REG_DWORD /d 1 /f
          reg add "HKU\DefaultUser\SOFTWARE\Microsoft\Windows\DWM" /v EnableAeroPeek /t REG_DWORD /d 1 /f
          
          [gc]::Collect()
          Start-Sleep -Seconds 2
          reg unload HKU\DefaultUser

      - name: Set High Performance Power Plan
        run: |
          powercfg /setactive 8c5e7fda-e8bf-4a96-9a85-a6e23a8c635c

      - name: Disable Password Complexity
        run: |
          secedit /export /cfg C:\secpol.cfg
          (Get-Content C:\secpol.cfg).Replace("PasswordComplexity = 1", "PasswordComplexity = 0") | Set-Content C:\secpol.cfg
          (Get-Content C:\secpol.cfg) -replace "MinimumPasswordLength = \d+", "MinimumPasswordLength = 1" | Set-Content C:\secpol.cfg
          secedit /configure /db C:\Windows\security\local.sdb /cfg C:\secpol.cfg /areas SECURITYPOLICY
          Remove-Item C:\secpol.cfg -Force

      - name: Create RDP User
        run: |
          $username = "kaiden"
          $password = "amaalik1"
          $securePass = ConvertTo-SecureString $password -AsPlainText -Force
          
          New-LocalUser -Name $username -Password $securePass -AccountNeverExpires -PasswordNeverExpires
          Add-LocalGroupMember -Group "Administrators" -Member $username
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member $username

      - name: Install Chocolatey
        run: |
          Set-ExecutionPolicy Bypass -Scope Process -Force
          [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.ServicePointManager]::SecurityProtocol -bor 3072
          iex ((New-Object System.Net.WebClient).DownloadString('https://community.chocolatey.org/install.ps1'))

      - name: Install Python and Tools
        run: |
          choco install python311 -y
          choco install git -y
          
          refreshenv
          $env:Path = [System.Environment]::GetEnvironmentVariable("Path","Machine") + ";" + [System.Environment]::GetEnvironmentVariable("Path","User")

      - name: Install Browsers
        run: |
          choco install brave -y
          choco install firefox -y

      - name: Setup Kaggle GPU Environment
        run: |
          refreshenv
          $env:Path = [System.Environment]::GetEnvironmentVariable("Path","Machine") + ";" + [System.Environment]::GetEnvironmentVariable("Path","User")
          
          # Install Kaggle CLI and dependencies
          pip install kaggle torch torchvision torchaudio numpy pandas jupyter

      - name: Configure Kaggle Credentials
        run: |
          # For kaiden user
          $kaggleDir = "C:\Users\kaiden\.kaggle"
          New-Item -Path $kaggleDir -ItemType Directory -Force | Out-Null
          
          $kaggleJson = @"
          {"username":"${{ secrets.KAGGLE_USERNAME }}","key":"${{ secrets.KAGGLE_KEY }}"}
          "@
          $kaggleJson | Out-File -FilePath "$kaggleDir\kaggle.json" -Encoding ASCII -NoNewline
          
          # For current user
          $currentKaggle = "$env:USERPROFILE\.kaggle"
          New-Item -Path $currentKaggle -ItemType Directory -Force | Out-Null
          $kaggleJson | Out-File -FilePath "$currentKaggle\kaggle.json" -Encoding ASCII -NoNewline

      - name: Create Kaggle GPU Scripts
        run: |
          # Create GPU work directory
          $gpuDir = "C:\KaggleGPU"
          New-Item -Path $gpuDir -ItemType Directory -Force | Out-Null
          
          # GPU Task Python Script
          $gpuScript = @'
          import os
          import json
          import time
          import subprocess
          import sys
          
          # Set Kaggle credentials
          os.environ['KAGGLE_USERNAME'] = 'KAGGLE_USER'
          os.environ['KAGGLE_KEY'] = 'KAGGLE_KEY_VALUE'
          
          def create_gpu_notebook(task_code, task_name="gpu-task"):
              """Create a Kaggle notebook with GPU enabled"""
              
              notebook = {
                  "metadata": {
                      "kernelspec": {
                          "language": "python",
                          "display_name": "Python 3",
                          "name": "python3"
                      },
                      "kaggle": {
                          "accelerator": "gpu",
                          "dataSources": [],
                          "isInternetEnabled": True,
                          "language": "python",
                          "sourceType": "notebook",
                          "isGpuEnabled": True
                      }
                  },
                  "nbformat_minor": 4,
                  "nbformat": 4,
                  "cells": [
                      {
                          "cell_type": "code",
                          "source": task_code,
                          "metadata": {"trusted": True},
                          "outputs": [],
                          "execution_count": None
                      }
                  ]
              }
              
              # Save notebook
              os.makedirs(f"C:/KaggleGPU/{task_name}", exist_ok=True)
              
              with open(f"C:/KaggleGPU/{task_name}/{task_name}.ipynb", "w") as f:
                  json.dump(notebook, f, indent=2)
              
              # Create kernel metadata
              kernel_meta = {
                  "id": f"KAGGLE_USER/{task_name}",
                  "title": task_name,
                  "code_file": f"{task_name}.ipynb",
                  "language": "python",
                  "kernel_type": "notebook",
                  "is_private": "true",
                  "enable_gpu": "true",
                  "enable_internet": "true"
              }
              
              with open(f"C:/KaggleGPU/{task_name}/kernel-metadata.json", "w") as f:
                  json.dump(kernel_meta, f, indent=2)
              
              return f"C:/KaggleGPU/{task_name}"
          
          def run_on_gpu(task_code, task_name="gpu-task", wait=True):
              """Submit task to Kaggle GPU and get results"""
              
              print(f"[GPU] Creating notebook: {task_name}")
              notebook_path = create_gpu_notebook(task_code, task_name)
              
              print(f"[GPU] Submitting to Kaggle GPU...")
              os.chdir(notebook_path)
              
              # Push to Kaggle
              result = subprocess.run(
                  ["kaggle", "kernels", "push"],
                  capture_output=True,
                  text=True
              )
              
              if result.returncode != 0:
                  print(f"[GPU] Error: {result.stderr}")
                  return None
              
              print(f"[GPU] Submitted! Kernel: KAGGLE_USER/{task_name}")
              
              if wait:
                  print(f"[GPU] Waiting for completion...")
                  while True:
                      status = subprocess.run(
                          ["kaggle", "kernels", "status", f"KAGGLE_USER/{task_name}"],
                          capture_output=True,
                          text=True
                      )
                      
                      if "complete" in status.stdout.lower():
                          print(f"[GPU] Task completed!")
                          break
                      elif "error" in status.stdout.lower():
                          print(f"[GPU] Task failed!")
                          break
                      
                      print(f"[GPU] Status: {status.stdout.strip()}")
                      time.sleep(30)
                  
                  # Get output
                  subprocess.run(
                      ["kaggle", "kernels", "output", f"KAGGLE_USER/{task_name}", "-p", notebook_path],
                      capture_output=True
                  )
                  
                  print(f"[GPU] Output saved to: {notebook_path}")
              
              return notebook_path
          
          if __name__ == "__main__":
              # Example: Test GPU
              test_code = """
          import torch
          print("=== KAGGLE GPU TEST ===")
          print(f"CUDA Available: {torch.cuda.is_available()}")
          if torch.cuda.is_available():
              print(f"GPU: {torch.cuda.get_device_name(0)}")
              print(f"Memory: {torch.cuda.get_device_properties(0).total_memory / 1024**3:.2f} GB")
              
              # Test computation
              x = torch.randn(10000, 10000, device='cuda')
              y = torch.matmul(x, x)
              print(f"Matrix multiplication test: PASSED")
          """
              
              run_on_gpu(test_code, "gpu-test")
          '@
          
          $gpuScript = $gpuScript.Replace("KAGGLE_USER", "${{ secrets.KAGGLE_USERNAME }}")
          $gpuScript = $gpuScript.Replace("KAGGLE_KEY_VALUE", "${{ secrets.KAGGLE_KEY }}")
          
          $gpuScript | Out-File -FilePath "$gpuDir\kaggle_gpu.py" -Encoding UTF8
          
          Write-Host "Kaggle GPU script created!"

      - name: Create Desktop Shortcuts
        run: |
          $desktopPath = "C:\Users\kaiden\Desktop"
          New-Item -Path $desktopPath -ItemType Directory -Force | Out-Null
          
          # GPU Test Script
          $testScript = @'
          @echo off
          cd C:\KaggleGPU
          python kaggle_gpu.py
          pause
          '@
          $testScript | Out-File -FilePath "$desktopPath\Test-Kaggle-GPU.bat" -Encoding ASCII
          
          # Interactive Python GPU
          $pythonScript = @'
          @echo off
          echo ============================================
          echo        KAGGLE GPU PYTHON CONSOLE
          echo ============================================
          echo.
          echo Use: from kaggle_gpu import run_on_gpu
          echo      run_on_gpu("your_code_here", "task-name")
          echo.
          cd C:\KaggleGPU
          python -i -c "from kaggle_gpu import run_on_gpu; print('Kaggle GPU ready! Use run_on_gpu(code, name)')"
          '@
          $pythonScript | Out-File -FilePath "$desktopPath\Kaggle-GPU-Console.bat" -Encoding ASCII
          
          # Open Kaggle Website
          $webScript = @'
          @echo off
          start https://www.kaggle.com/USERNAME/code
          '@
          $webScript = $webScript.Replace("USERNAME", "${{ secrets.KAGGLE_USERNAME }}")
          $webScript | Out-File -FilePath "$desktopPath\Open-Kaggle.bat" -Encoding ASCII
          
          # Quick GPU Task Creator
          $quickScript = @'
          import sys
          sys.path.insert(0, "C:/KaggleGPU")
          from kaggle_gpu import run_on_gpu
          
          print("=== QUICK GPU TASK ===")
          print("Enter your Python code (press Enter twice to submit):")
          print()
          
          lines = []
          while True:
              line = input()
              if line == "":
                  break
              lines.append(line)
          
          code = "\n".join(lines)
          
          task_name = input("Task name (default: quick-task): ").strip() or "quick-task"
          
          print(f"\nSubmitting to Kaggle GPU...")
          run_on_gpu(code, task_name)
          '@
          $quickScript | Out-File -FilePath "$desktopPath\Quick-GPU-Task.py" -Encoding UTF8
          
          $quickBat = @'
          @echo off
          cd C:\KaggleGPU
          python "C:\Users\kaiden\Desktop\Quick-GPU-Task.py"
          pause
          '@
          $quickBat | Out-File -FilePath "$desktopPath\Quick-GPU-Task.bat" -Encoding ASCII
          
          Write-Host "Desktop shortcuts created!"

      - name: Create Example GPU Tasks
        run: |
          $examplesDir = "C:\KaggleGPU\examples"
          New-Item -Path $examplesDir -ItemType Directory -Force | Out-Null
          
          # Example 1: GPU Benchmark
          $benchmark = @'
          # GPU Benchmark - Run on Kaggle Tesla P100
          
          import torch
          import time
          
          print("=== GPU BENCHMARK ===")
          print(f"GPU: {torch.cuda.get_device_name(0)}")
          print()
          
          # Matrix multiplication benchmark
          sizes = [1000, 5000, 10000, 15000]
          
          for size in sizes:
              x = torch.randn(size, size, device='cuda')
              
              torch.cuda.synchronize()
              start = time.time()
              
              y = torch.matmul(x, x)
              
              torch.cuda.synchronize()
              elapsed = time.time() - start
              
              print(f"Matrix {size}x{size}: {elapsed:.4f} seconds")
              
              del x, y
              torch.cuda.empty_cache()
          
          print()
          print("Benchmark complete!")
          '@
          $benchmark | Out-File -FilePath "$examplesDir\benchmark.py" -Encoding UTF8
          
          # Example 2: AI Image Generation
          $aiImage = @'
          # AI Image Generation with Stable Diffusion
          
          !pip install diffusers transformers accelerate -q
          
          import torch
          from diffusers import StableDiffusionPipeline
          
          print("Loading Stable Diffusion...")
          
          pipe = StableDiffusionPipeline.from_pretrained(
              "runwayml/stable-diffusion-v1-5",
              torch_dtype=torch.float16
          ).to("cuda")
          
          prompt = "A beautiful sunset over mountains, digital art"
          
          print(f"Generating: {prompt}")
          
          image = pipe(prompt).images[0]
          image.save("generated_image.png")
          
          print("Image saved to: generated_image.png")
          '@
          $aiImage | Out-File -FilePath "$examplesDir\ai_image.py" -Encoding UTF8
          
          # Example 3: Train Neural Network
          $trainNN = @'
          # Train a simple neural network on GPU
          
          import torch
          import torch.nn as nn
          import torch.optim as optim
          import time
          
          print(f"GPU: {torch.cuda.get_device_name(0)}")
          
          # Simple neural network
          class Net(nn.Module):
              def __init__(self):
                  super().__init__()
                  self.layers = nn.Sequential(
                      nn.Linear(1000, 500),
                      nn.ReLU(),
                      nn.Linear(500, 250),
                      nn.ReLU(),
                      nn.Linear(250, 
