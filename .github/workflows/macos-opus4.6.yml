name: macOS Remote Desktop - Official

on:
  workflow_dispatch:
    inputs:
      tailscale_authkey:
        description: 'Tailscale Auth Key'
        required: true
        type: string

jobs:
  setup-macos:
    runs-on: macos-latest
    timeout-minutes: 360

    steps:
      # ========================================
      # STEP 1: System Info & Debug
      # ========================================
      - name: Display System Information
        run: |
          echo "=== System Information ==="
          sw_vers
          echo ""
          echo "=== Hardware Info ==="
          system_profiler SPHardwareDataType
          echo ""
          echo "=== Current User ==="
          whoami
          id
          echo ""
          echo "=== Network Interfaces ==="
          ifconfig | grep -E "^[a-z]|inet "

      # ========================================
      # STEP 2: Create User Account
      # ========================================
      - name: Create User Account
        run: |
          echo "=== Creating user 'kaiden' ==="
          
          # Create user
          sudo dscl . -create /Users/kaiden
          sudo dscl . -create /Users/kaiden UserShell /bin/zsh
          sudo dscl . -create /Users/kaiden RealName "Kaiden"
          sudo dscl . -create /Users/kaiden UniqueID 1001
          sudo dscl . -create /Users/kaiden PrimaryGroupID 80
          sudo dscl . -create /Users/kaiden NFSHomeDirectory /Users/kaiden
          sudo dscl . -passwd /Users/kaiden kaiden123
          
          # Add to admin group
          sudo dscl . -append /Groups/admin GroupMembership kaiden
          
          # Create home directory
          sudo createhomedir -c -u kaiden
          
          echo "=== Verifying user creation ==="
          dscl . -read /Users/kaiden
          
          echo "=== User 'kaiden' created successfully ==="

      # ========================================
      # STEP 3: TCP Keepalive Configuration
      # ========================================
      - name: Configure TCP Keepalive (Prevent Connection Drops)
        run: |
          echo "=== Configuring TCP Keepalive Settings ==="
          
          # These settings prevent NAT/firewall from dropping idle connections
          sudo sysctl -w net.inet.tcp.keepidle=60000      # 60 seconds idle before probe
          sudo sysctl -w net.inet.tcp.keepintvl=10000     # 10 second probe interval  
          sudo sysctl -w net.inet.tcp.keepcnt=10          # 10 probes before drop
          sudo sysctl -w net.inet.tcp.always_keepalive=1  # Enable for all connections
          
          echo "=== Verifying TCP settings ==="
          sysctl net.inet.tcp.keepidle
          sysctl net.inet.tcp.keepintvl
          sysctl net.inet.tcp.keepcnt
          sysctl net.inet.tcp.always_keepalive
          
          echo "=== TCP Keepalive configured ==="

      # ========================================
      # STEP 4: Install BetterDisplay for Virtual Display
      # ========================================
      - name: Install BetterDisplay (Virtual Display for Headless)
        run: |
          echo "=== Installing BetterDisplay ==="
          
          # Install BetterDisplay app
          brew install --cask betterdisplay
          
          echo "=== BetterDisplay installed ==="
          ls -la /Applications/ | grep -i better || echo "Checking Homebrew Caskroom..."
          ls -la /opt/homebrew/Caskroom/betterdisplay/ || ls -la /usr/local/Caskroom/betterdisplay/ || true

      - name: Install BetterDisplay CLI
        run: |
          echo "=== Installing BetterDisplay CLI ==="
          
          # Add the tap and install CLI
          brew tap waydabber/betterdisplay
          brew install betterdisplaycli
          
          echo "=== Verifying CLI installation ==="
          which betterdisplaycli || echo "CLI not in PATH, checking brew..."
          brew list betterdisplaycli
          
          echo "=== BetterDisplay CLI installed ==="

      - name: Create Virtual Display
        run: |
          echo "=== Starting BetterDisplay ==="
          
          # Launch BetterDisplay
          open -a "BetterDisplay"
          
          # Wait for app to initialize
          echo "Waiting for BetterDisplay to initialize..."
          sleep 10
          
          echo "=== Creating Virtual Display ==="
          
          # Create virtual display (1920x1080)
          betterdisplaycli create set \
              --type=VirtualScreen \
              --aspectWidth=16 \
              --aspectHeight=9 \
              --virtualScreenHiDPI=on \
              --sizeInch=27 \
              --virtualScreenName="VirtualDisplay" || echo "Create command completed"
          
          sleep 3
          
          echo "=== Connecting Virtual Display ==="
          
          # Connect and set as main display
          betterdisplaycli set --name="VirtualDisplay" --connected=on --main=on || echo "Set connected completed"
          
          sleep 2
          
          # Set resolution
          betterdisplaycli set --name="VirtualDisplay" --resolution=1920x1080 --refreshRate=60 --hiDPI=on || echo "Set resolution completed"
          
          echo "=== Listing displays ==="
          betterdisplaycli list || echo "List command completed"
          
          echo "=== Virtual Display setup complete ==="

      # ========================================
      # STEP 5: TCC Permissions (Screen Recording/Accessibility)
      # ========================================
      - name: Configure TCC Permissions
        run: |
          echo "=== Configuring TCC Permissions ==="
          
          TCC_DB="/Library/Application Support/com.apple.TCC/TCC.db"
          
          # RustDesk bundle ID
          RUSTDESK_BUNDLE="com.carriez.rustdesk"
          
          echo "=== Adding Screen Capture permissions ==="
          sudo sqlite3 "$TCC_DB" "INSERT OR REPLACE INTO access (service, client, client_type, auth_value, auth_reason, auth_version, indirect_object_identifier_type, indirect_object_identifier, flags, last_modified) VALUES ('kTCCServiceScreenCapture', '$RUSTDESK_BUNDLE', 0, 2, 0, 1, 0, 'UNUSED', 0, strftime('%s', 'now'));"
          
          echo "=== Adding Accessibility permissions ==="
          sudo sqlite3 "$TCC_DB" "INSERT OR REPLACE INTO access (service, client, client_type, auth_value, auth_reason, auth_version, indirect_object_identifier_type, indirect_object_identifier, flags, last_modified) VALUES ('kTCCServiceAccessibility', '$RUSTDESK_BUNDLE', 0, 2, 0, 1, 0, 'UNUSED', 0, strftime('%s', 'now'));"
          
          echo "=== Adding PostEvent permissions ==="
          sudo sqlite3 "$TCC_DB" "INSERT OR REPLACE INTO access (service, client, client_type, auth_value, auth_reason, auth_version, indirect_object_identifier_type, indirect_object_identifier, flags, last_modified) VALUES ('kTCCServicePostEvent', '$RUSTDESK_BUNDLE', 0, 2, 0, 1, 0, 'UNUSED', 0, strftime('%s', 'now'));"
          
          # Also add for ARD Agent
          ARD_AGENT="/System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/MacOS/ARDAgent"
          
          echo "=== Adding ARD Agent permissions ==="
          sudo sqlite3 "$TCC_DB" "INSERT OR REPLACE INTO access (service, client, client_type, auth_value, auth_reason, auth_version, indirect_object_identifier_type, indirect_object_identifier, flags, last_modified) VALUES ('kTCCServiceScreenCapture', '$ARD_AGENT', 1, 2, 0, 1, 0, 'UNUSED', 0, strftime('%s', 'now'));"
          sudo sqlite3 "$TCC_DB" "INSERT OR REPLACE INTO access (service, client, client_type, auth_value, auth_reason, auth_version, indirect_object_identifier_type, indirect_object_identifier, flags, last_modified) VALUES ('kTCCServiceAccessibility', '$ARD_AGENT', 1, 2, 0, 1, 0, 'UNUSED', 0, strftime('%s', 'now'));"
          
          echo "=== Verifying TCC entries ==="
          sudo sqlite3 "$TCC_DB" "SELECT service, client, auth_value FROM access WHERE client LIKE '%rustdesk%' OR client LIKE '%ARD%';"
          
          echo "=== TCC Permissions configured ==="

      # ========================================
      # STEP 6: Configure Apple Remote Desktop (ARD)
      # ========================================
      - name: Configure ARD/VNC
        run: |
          echo "=== Configuring Apple Remote Desktop ==="
          
          KICKSTART="/System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart"
          
          # Enable ARD for all users
          echo "=== Activating ARD ==="
          sudo $KICKSTART -activate
          
          echo "=== Configuring ARD access ==="
          sudo $KICKSTART -configure \
              -allowAccessFor -allUsers \
              -privs -all
          
          echo "=== Enabling VNC legacy viewers ==="
          sudo defaults write /Library/Preferences/com.apple.RemoteManagement VNCLegacyConnectionsEnabled -bool true
          
          echo "=== Setting VNC password ==="
          # Set VNC password (kaiden123)
          echo "kaiden123" | perl -we 'BEGIN { @k = unpack "C*", pack "H*", "1734516E8BA8C5E2FF1C39567390ADCA"}; $_ = <>; chomp; s/^(.{8}).*$/$1/; @p = unpack "C*", $_; foreach (@k) { printf "%02X", $_ ^ (shift @p || 0) }; print "\n"' | sudo tee /Library/Preferences/com.apple.VNCSettings.txt
          
          echo "=== Restarting ARD Agent ==="
          sudo $KICKSTART -restart -agent -console
          
          echo "=== Verifying ARD status ==="
          sudo $KICKSTART -agent -print
          
          # Check if screen sharing service is running
          echo "=== Screen Sharing service status ==="
          sudo launchctl list | grep -i screen || echo "Checking for screensharing..."
          
          echo "=== ARD Configuration complete ==="

      # ========================================
      # STEP 7: Install and Configure RustDesk
      # ========================================
      - name: Install RustDesk
        run: |
          echo "=== Installing RustDesk ==="
          
          brew install --cask rustdesk
          
          echo "=== Verifying RustDesk installation ==="
          ls -la /Applications/ | grep -i rust
          
          echo "=== RustDesk installed ==="

      - name: Configure RustDesk for High Quality + Stability
        run: |
          echo "=== Creating RustDesk config directory ==="
          
          # Create config directory for kaiden user
          sudo mkdir -p "/Users/kaiden/Library/Application Support/RustDesk/config"
          sudo chown -R kaiden:staff "/Users/kaiden/Library/Application Support/RustDesk"
          
          echo "=== Writing optimized RustDesk configuration ==="
          
          # Write config optimized for:
          # - High quality (like using real macOS)
          # - Fast/responsive
          # - No freezing/disconnects
          sudo tee "/Users/kaiden/Library/Application Support/RustDesk/config/RustDesk2.toml" << 'EOF'
          # ============================================
          # RustDesk Configuration - High Quality + Fast
          # ============================================

          # === Stability Settings (Prevent Freezing) ===
          # Disable hardware codec - known to cause freezes on macOS
          enable-hwcodec = 'N'

          # Disable texture rendering - causes freezes after 10-15 min
          use-texture-render = 'N'

          # Force software rendering for stability
          allow-always-software-render = 'Y'

          # Disable auto-disconnect (prevents timeout disconnects)
          allow-auto-disconnect = 'N'
          auto-disconnect-timeout = '0'

          # === Quality Settings (Like Real macOS) ===
          # High image quality - balanced for speed
          image-quality = 'balanced'

          # Custom quality: Higher value = better quality (10-100)
          # 80 gives excellent quality while maintaining speed
          custom-image-quality = '80'

          # Higher FPS for smooth experience
          custom-fps = '60'

          # Codec preference - VP9 for better quality at same bitrate
          codec-preference = 'vp9'

          # === Performance Settings ===
          # Enable adaptive bitrate for dynamic quality
          enable-abr = 'Y'

          # Enable UDP hole punching for faster P2P
          enable-udp-punch = 'Y'

          # Prefer direct connections (faster, lower latency)
          direct-server = 'Y'

          # Enable LAN discovery for local connections
          enable-lan-discovery = 'Y'

          # === Visual Settings (Keep Animations) ===
          # Don't remove wallpaper - keep full visual experience
          allow-remove-wallpaper = 'N'

          # === Connection Settings ===
          # Allow auto-accept for convenience
          allow-auto-accept = 'Y'
          EOF
          
          echo "=== Config file contents ==="
          cat "/Users/kaiden/Library/Application Support/RustDesk/config/RustDesk2.toml"
          
          echo "=== Setting permissions ==="
          sudo chown kaiden:staff "/Users/kaiden/Library/Application Support/RustDesk/config/RustDesk2.toml"
          
          echo "=== RustDesk configuration complete ==="

      - name: Start RustDesk Service
        run: |
          echo "=== Starting RustDesk ==="
          
          # Start RustDesk as kaiden user
          sudo -u kaiden open -a RustDesk
          
          # Wait for RustDesk to initialize
          echo "Waiting for RustDesk to start..."
          sleep 10
          
          echo "=== Checking RustDesk process ==="
          ps aux | grep -i rustdesk | grep -v grep || echo "RustDesk process check complete"
          
          echo "=== Getting RustDesk ID ==="
          # Try to get RustDesk ID from config
          if [ -f "/Users/kaiden/Library/Application Support/RustDesk/config/RustDesk.toml" ]; then
              cat "/Users/kaiden/Library/Application Support/RustDesk/config/RustDesk.toml"
          else
              echo "RustDesk.toml not yet created, ID will be shown on first run"
          fi
          
          echo "=== RustDesk started ==="

      # ========================================
      # STEP 8: Install and Configure Tailscale
      # ========================================
      - name: Install Tailscale
        run: |
          echo "=== Installing Tailscale ==="
          
          brew install tailscale
          
          echo "=== Verifying Tailscale installation ==="
          which tailscale
          tailscale version
          
          echo "=== Tailscale installed ==="

      - name: Start Tailscale
        run: |
          echo "=== Starting Tailscale daemon ==="
          
          # Start tailscaled in background
          sudo tailscaled --state=/var/lib/tailscale/tailscaled.state --socket=/var/run/tailscale/tailscaled.sock &
          
          # Wait for daemon to start
          echo "Waiting for tailscaled..."
          sleep 5
          
          echo "=== Connecting to Tailscale network ==="
          sudo tailscale up --authkey=${{ inputs.tailscale_authkey }} --hostname=github-macos-runner
          
          echo "=== Tailscale status ==="
          tailscale status
          
          echo "=== Tailscale IP ==="
          tailscale ip -4
          
          echo "=== Tailscale connected ==="

      # ========================================
      # STEP 9: Display Connection Info
      # ========================================
      - name: Display Connection Information
        run: |
          echo ""
          echo "============================================"
          echo "    REMOTE DESKTOP CONNECTION INFO"
          echo "============================================"
          echo ""
          echo "=== Tailscale IP ==="
          TAILSCALE_IP=$(tailscale ip -4)
          echo "IP: $TAILSCALE_IP"
          echo ""
          echo "=== VNC Connection ==="
          echo "Address: vnc://$TAILSCALE_IP:5900"
          echo "Password: kaiden123"
          echo ""
          echo "=== RustDesk ==="
          echo "Look for RustDesk ID in the logs above or connect via Tailscale IP"
          echo ""
          echo "=== User Credentials ==="
          echo "Username: kaiden"
          echo "Password: kaiden123"
          echo ""
          echo "============================================"
          echo ""
          
          # Try to get RustDesk ID
          echo "=== Attempting to retrieve RustDesk ID ==="
          if [ -f "/Users/kaiden/Library/Application Support/RustDesk/config/RustDesk.toml" ]; then
              grep -i "id" "/Users/kaiden/Library/Application Support/RustDesk/config/RustDesk.toml" || echo "ID not in config"
          fi
          
          # Also check system-wide config
          if [ -f "/Library/Application Support/RustDesk/config/RustDesk.toml" ]; then
              grep -i "id" "/Library/Application Support/RustDesk/config/RustDesk.toml" || echo "ID not in system config"
          fi

      # ========================================
      # STEP 10: Keep Session Alive
      # ========================================
      - name: Keep Session Alive
        run: |
          echo "=== Starting keep-alive loop ==="
          echo "Session will remain active for up to 6 hours"
          echo ""
          
          # Create keepalive log
          KEEPALIVE_LOG="/tmp/keepalive.log"
          
          # Keep-alive loop with periodic status checks
          START_TIME=$(date +%s)
          ITERATION=0
          
          while true; do
              ITERATION=$((ITERATION + 1))
              CURRENT_TIME=$(date +%s)
              ELAPSED=$(( (CURRENT_TIME - START_TIME) / 60 ))
              
              echo "$(date): Keep-alive iteration $ITERATION (${ELAPSED} minutes elapsed)" | tee -a $KEEPALIVE_LOG
              
              # Every 5 minutes, check services
              if [ $((ITERATION % 5)) -eq 0 ]; then
                  echo "=== Service Health Check ===" | tee -a $KEEPALIVE_LOG
                  
                  # Check RustDesk
                  if pgrep -f RustDesk > /dev/null; then
                      echo "RustDesk: RUNNING" | tee -a $KEEPALIVE_LOG
                  else
                      echo "RustDesk: NOT RUNNING - Restarting..." | tee -a $KEEPALIVE_LOG
                      sudo -u kaiden open -a RustDesk
                  fi
                  
                  # Check Tailscale
                  if tailscale status > /dev/null 2>&1; then
                      echo "Tailscale: CONNECTED" | tee -a $KEEPALIVE_LOG
                      tailscale ip -4 | tee -a $KEEPALIVE_LOG
                  else
                      echo "Tailscale: DISCONNECTED" | tee -a $KEEPALIVE_LOG
                  fi
                  
                  # Check ARD
                  if pgrep -f ARDAgent > /dev/null; then
                      echo "ARD Agent: RUNNING" | tee -a $KEEPALIVE_LOG
                  else
                      echo "ARD Agent: NOT RUNNING" | tee -a $KEEPALIVE_LOG
                  fi
                  
                  # Check BetterDisplay
                  if pgrep -f BetterDisplay > /dev/null; then
                      echo "BetterDisplay: RUNNING" | tee -a $KEEPALIVE_LOG
                  else
                      echo "BetterDisplay: NOT RUNNING - Restarting..." | tee -a $KEEPALIVE_LOG
                      open -a BetterDisplay
                  fi
                  
                  echo "===========================" | tee -a $KEEPALIVE_LOG
              fi
              
              # Sleep for 1 minute
              sleep 60
          done
