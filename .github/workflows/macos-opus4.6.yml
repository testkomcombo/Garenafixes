name: macOS Remote Desktop - Official

on:
  workflow_dispatch:

jobs:
  setup-macos:
    runs-on: macos-latest
    timeout-minutes: 360

    steps:
      - name: System Info
        run: |
          sw_vers
          system_profiler SPHardwareDataType
          whoami && id

      - name: Install Dependencies
        run: brew install tailscale

      - name: Create User Account
        run: |
          sudo dscl . -create /Users/kaiden
          sudo dscl . -create /Users/kaiden UserShell /bin/zsh
          sudo dscl . -create /Users/kaiden RealName "Kaiden"
          sudo dscl . -create /Users/kaiden UniqueID 1001
          sudo dscl . -create /Users/kaiden PrimaryGroupID 80
          sudo dscl . -create /Users/kaiden NFSHomeDirectory /Users/kaiden
          sudo dscl . -passwd /Users/kaiden kaiden123
          sudo dscl . -append /Groups/admin GroupMembership kaiden
          sudo createhomedir -c -u kaiden

      - name: Configure TCC Permissions
        run: |
          TCC_DB="/Library/Application Support/com.apple.TCC/TCC.db"
          for SVC in kTCCServiceScreenCapture kTCCServiceAccessibility kTCCServicePostEvent; do
            for CLIENT in com.carriez.rustdesk; do
              sudo sqlite3 "$TCC_DB" "INSERT OR REPLACE INTO access (service, client, client_type, auth_value, auth_reason, auth_version, indirect_object_identifier_type, indirect_object_identifier, flags, last_modified) VALUES ('$SVC', '$CLIENT', 0, 2, 0, 1, 0, 'UNUSED', 0, strftime('%s', 'now'));"
            done
          done
          ARD_AGENT="/System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/MacOS/ARDAgent"
          for SVC in kTCCServiceScreenCapture kTCCServiceAccessibility; do
            sudo sqlite3 "$TCC_DB" "INSERT OR REPLACE INTO access (service, client, client_type, auth_value, auth_reason, auth_version, indirect_object_identifier_type, indirect_object_identifier, flags, last_modified) VALUES ('$SVC', '$ARD_AGENT', 1, 2, 0, 1, 0, 'UNUSED', 0, strftime('%s', 'now'));"
          done
          sudo sqlite3 "$TCC_DB" "SELECT service, client, auth_value FROM access WHERE client LIKE '%rustdesk%' OR client LIKE '%ARD%';"

      - name: Configure ARD/VNC
        run: |
          KS="/System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart"
          sudo launchctl load -w /System/Library/LaunchDaemons/com.apple.screensharing.plist 2>&1 || true
          sudo $KS -activate
          sudo $KS -configure -allowAccessFor -allUsers -privs -all
          sudo defaults write /Library/Preferences/com.apple.RemoteManagement VNCLegacyConnectionsEnabled -bool true
          echo "kaiden12" | perl -we 'BEGIN { @k = unpack "C*", pack "H*", "1734516E8BA8C5E2FF1C39567390ADCA"}; $_ = <>; chomp; s/^(.{8}).*$/$1/; @p = unpack "C*", $_; foreach (@k) { printf "%02X", $_ ^ (shift @p || 0) }; print "\n"' | sudo tee /Library/Preferences/com.apple.VNCSettings.txt > /dev/null
          sudo $KS -restart -agent -console
          sleep 3
          ps aux | grep -i ARDAgent | grep -v grep || echo "ARD Agent not running"
          sudo lsof -i :5900 2>/dev/null || echo "Port 5900 not listening yet"

      - name: Install and Configure RustDesk
        run: |
          brew install --cask rustdesk
          CONF_DIR="/Users/kaiden/Library/Application Support/RustDesk/config"
          sudo mkdir -p "$CONF_DIR"
          sudo tee "$CONF_DIR/RustDesk2.toml" > /dev/null << 'EOF'
          enable-hwcodec = "N"
          allow-always-software-render = "Y"
          allow-auto-disconnect = "N"
          auto-disconnect-timeout = "0"
          image-quality = "custom"
          custom-image-quality = "90"
          custom-fps = "60"
          codec-preference = "vp9"
          enable-abr = "Y"
          allow-auto-accept = "Y"
          EOF
          sudo chown -R kaiden:staff "/Users/kaiden/Library/Application Support/RustDesk"
          sudo cat "$CONF_DIR/RustDesk2.toml"
          sudo -u kaiden -H open -a RustDesk
          sleep 15
          ps aux | grep -i rustdesk | grep -v grep || echo "RustDesk not running"
          sudo find / -name "RustDesk.toml" -type f 2>/dev/null | head -5 || true

      - name: Start Tailscale
        env:
          TAILSCALE_AUTHKEY: ${{ secrets.TAILSCALE_AUTHKEY }}
        run: |
          sudo mkdir -p /var/lib/tailscale /var/run/tailscale
          sudo tailscaled --state=/var/lib/tailscale/tailscaled.state --socket=/var/run/tailscale/tailscaled.sock &
          sleep 5
          sudo tailscale up --authkey="$TAILSCALE_AUTHKEY" --hostname=github-macos-runner
          tailscale status
          tailscale ip -4

      - name: Connection Info
        run: |
          TSIP=$(tailscale ip -4)
          echo "============================================"
          echo "  VNC:  vnc://$TSIP:5900  (password: kaiden12)"
          echo "  User: kaiden / kaiden123"
          echo "============================================"
          RDTOML=$(sudo find / -name "RustDesk.toml" -type f 2>/dev/null | head -1)
          [ -n "$RDTOML" ] && sudo cat "$RDTOML" || echo "RustDesk ID not found yet"

      - name: Keep Alive
        run: |
          echo "Session active for up to 6 hours"
          START=$(date +%s)
          i=0
          while true; do
            i=$((i + 1))
            MINS=$(( ($(date +%s) - START) / 60 ))
            echo "$(date): iteration $i (${MINS}m elapsed)"
            if [ $((i % 5)) -eq 0 ]; then
              pgrep -f RustDesk > /dev/null 2>&1 && echo "RustDesk: OK" || { echo "RustDesk: restarting"; sudo -u kaiden -H open -a RustDesk; }
              tailscale status > /dev/null 2>&1 && echo "Tailscale: OK ($(tailscale ip -4))" || echo "Tailscale: DOWN"
              pgrep -f ARDAgent > /dev/null 2>&1 && echo "ARD: OK" || echo "ARD: DOWN"
            fi
            sleep 60
          done
