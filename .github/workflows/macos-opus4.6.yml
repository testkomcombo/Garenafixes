name: macOS Remote Desktop - Official

on:
  workflow_dispatch:

jobs:
  setup-macos:
    runs-on: macos-latest
    timeout-minutes: 360
    defaults:
      run:
        working-directory: /Users/runner

    steps:
      # ========================================
      # STEP 1: System Info & Debug
      # ========================================
      - name: Display System Information
        run: |
          echo "=== System Information ==="
          sw_vers
          echo ""
          echo "=== Hardware Info ==="
          system_profiler SPHardwareDataType
          echo ""
          echo "=== Current User ==="
          whoami
          id
          echo ""
          echo "=== Network Interfaces ==="
          ifconfig | grep -E "^[a-z]|inet "

      # ========================================
      # STEP 2: Create User Account
      # ========================================
      - name: Create User Account
        run: |
          echo "=== Creating user 'kaiden' ==="
          sudo dscl . -create /Users/kaiden
          sudo dscl . -create /Users/kaiden UserShell /bin/zsh
          sudo dscl . -create /Users/kaiden RealName "Kaiden"
          sudo dscl . -create /Users/kaiden UniqueID 1001
          sudo dscl . -create /Users/kaiden PrimaryGroupID 80
          sudo dscl . -create /Users/kaiden NFSHomeDirectory /Users/kaiden
          sudo dscl . -passwd /Users/kaiden kaiden123
          sudo dscl . -append /Groups/admin GroupMembership kaiden
          sudo createhomedir -c -u kaiden
          echo "=== Verifying user creation ==="
          dscl . -read /Users/kaiden
          echo "=== User 'kaiden' created successfully ==="

      # ========================================
      # STEP 3: TCP Keepalive Configuration
      # ========================================
      - name: Configure TCP Keepalive (Prevent Connection Drops)
        run: |
          echo "=== Configuring TCP Keepalive Settings ==="
          sudo sysctl -w net.inet.tcp.keepidle=60000
          sudo sysctl -w net.inet.tcp.keepintvl=10000
          sudo sysctl -w net.inet.tcp.keepcnt=10
          sudo sysctl -w net.inet.tcp.always_keepalive=1
          echo "=== Verifying TCP settings ==="
          sysctl net.inet.tcp.keepidle
          sysctl net.inet.tcp.keepintvl
          sysctl net.inet.tcp.keepcnt
          sysctl net.inet.tcp.always_keepalive
          echo "=== TCP Keepalive configured ==="

      # ========================================
      # STEP 4: Install BetterDisplay for Virtual Display
      # ========================================
      - name: Install BetterDisplay (Virtual Display for Headless)
        run: |
          echo "=== Installing BetterDisplay ==="
          brew install --cask betterdisplay
          echo "=== BetterDisplay installed ==="
          ls -la /Applications/ | grep -i better || echo "Checking Homebrew Caskroom..."
          ls -la /opt/homebrew/Caskroom/betterdisplay/ || ls -la /usr/local/Caskroom/betterdisplay/ || true

      - name: Create Virtual Display
        run: |
          echo "=== Starting BetterDisplay ==="
          if [ -d "/Applications/BetterDisplay.app" ]; then
            open "/Applications/BetterDisplay.app"
          else
            echo "BetterDisplay.app not found in /Applications"
            ls -la /Applications
            exit 1
          fi
          echo "Waiting for BetterDisplay to initialize..."
          sleep 10
          echo "=== Creating Virtual Display ==="
          betterdisplaycli create set --type=VirtualScreen --aspectWidth=16 --aspectHeight=9 --virtualScreenHiDPI=on --sizeInch=27 --virtualScreenName="VirtualDisplay" || echo "Create command completed"
          sleep 3
          echo "=== Connecting Virtual Display ==="
          betterdisplaycli set --name="VirtualDisplay" --connected=on --main=on || echo "Set connected completed"
          sleep 2
          betterdisplaycli set --name="VirtualDisplay" --resolution=1920x1080 --refreshRate=60 --hiDPI=on || echo "Set resolution completed"
          echo "=== Listing displays ==="
          betterdisplaycli list || echo "List command completed"
          echo "=== Virtual Display setup complete ==="

      # ========================================
      # STEP 5: TCC Permissions (Screen Recording/Accessibility)
      # ========================================
      - name: Configure TCC Permissions
        run: |
          echo "=== Configuring TCC Permissions ==="
          TCC_DB="/Library/Application Support/com.apple.TCC/TCC.db"
          RUSTDESK_BUNDLE="com.carriez.rustdesk"
          echo "=== Adding Screen Capture permissions ==="
          sudo sqlite3 "$TCC_DB" "INSERT OR REPLACE INTO access (service, client, client_type, auth_value, auth_reason, auth_version, indirect_object_identifier_type, indirect_object_identifier, flags, last_modified) VALUES ('kTCCServiceScreenCapture', '$RUSTDESK_BUNDLE', 0, 2, 0, 1, 0, 'UNUSED', 0, strftime('%s', 'now'));"
          echo "=== Adding Accessibility permissions ==="
          sudo sqlite3 "$TCC_DB" "INSERT OR REPLACE INTO access (service, client, client_type, auth_value, auth_reason, auth_version, indirect_object_identifier_type, indirect_object_identifier, flags, last_modified) VALUES ('kTCCServiceAccessibility', '$RUSTDESK_BUNDLE', 0, 2, 0, 1, 0, 'UNUSED', 0, strftime('%s', 'now'));"
          echo "=== Adding PostEvent permissions ==="
          sudo sqlite3 "$TCC_DB" "INSERT OR REPLACE INTO access (service, client, client_type, auth_value, auth_reason, auth_version, indirect_object_identifier_type, indirect_object_identifier, flags, last_modified) VALUES ('kTCCServicePostEvent', '$RUSTDESK_BUNDLE', 0, 2, 0, 1, 0, 'UNUSED', 0, strftime('%s', 'now'));"
          ARD_AGENT="/System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/MacOS/ARDAgent"
          echo "=== Adding ARD Agent permissions ==="
          sudo sqlite3 "$TCC_DB" "INSERT OR REPLACE INTO access (service, client, client_type, auth_value, auth_reason, auth_version, indirect_object_identifier_type, indirect_object_identifier, flags, last_modified) VALUES ('kTCCServiceScreenCapture', '$ARD_AGENT', 1, 2, 0, 1, 0, 'UNUSED', 0, strftime('%s', 'now'));"
          sudo sqlite3 "$TCC_DB" "INSERT OR REPLACE INTO access (service, client, client_type, auth_value, auth_reason, auth_version, indirect_object_identifier_type, indirect_object_identifier, flags, last_modified) VALUES ('kTCCServiceAccessibility', '$ARD_AGENT', 1, 2, 0, 1, 0, 'UNUSED', 0, strftime('%s', 'now'));"
          echo "=== Verifying TCC entries ==="
          sudo sqlite3 "$TCC_DB" "SELECT service, client, auth_value FROM access WHERE client LIKE '%rustdesk%' OR client LIKE '%ARD%';"
          echo "=== TCC Permissions configured ==="

      # ========================================
      # STEP 6: Configure Apple Remote Desktop (ARD)
      # ========================================
      - name: Configure ARD/VNC
        run: |
          echo "=== Configuring Apple Remote Desktop ==="
          KICKSTART="/System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart"
          echo "=== Activating ARD ==="
          sudo $KICKSTART -activate
          echo "=== Configuring ARD access ==="
          sudo $KICKSTART -configure -allowAccessFor -allUsers -privs -all
          echo "=== Enabling VNC legacy viewers ==="
          sudo defaults write /Library/Preferences/com.apple.RemoteManagement VNCLegacyConnectionsEnabled -bool true
          echo "=== Setting VNC password ==="
          echo "kaiden123" | perl -we 'BEGIN { @k = unpack "C*", pack "H*", "1734516E8BA8C5E2FF1C39567390ADCA"}; $_ = <>; chomp; s/^(.{8}).*$/$1/; @p = unpack "C*", $_; foreach (@k) { printf "%02X", $_ ^ (shift @p || 0) }; print "\n"' | sudo tee /Library/Preferences/com.apple.VNCSettings.txt
          echo "=== Restarting ARD Agent ==="
          sudo $KICKSTART -restart -agent -console
          echo "=== Verifying ARD status ==="
          sudo $KICKSTART -agent -print
          echo "=== Screen Sharing service status ==="
          sudo launchctl list | grep -i screen || echo "Checking for screensharing..."
          echo "=== ARD Configuration complete ==="

      # ========================================
      # STEP 7: Install and Configure RustDesk
      # ========================================
      - name: Install RustDesk
        run: |
          echo "=== Installing RustDesk ==="
          brew install --cask rustdesk
          echo "=== Verifying RustDesk installation ==="
          ls -la /Applications/ | grep -i rust
          echo "=== RustDesk installed ==="

      - name: Configure RustDesk for High Quality + Stability
        run: |
          echo "=== Creating RustDesk config directory ==="
          sudo mkdir -p "/Users/kaiden/Library/Application Support/RustDesk/config"
          sudo chown -R kaiden:staff "/Users/kaiden/Library/Application Support/RustDesk"
          echo "=== Writing optimized RustDesk configuration ==="
          cat << 'RUSTDESK_CONFIG' | sudo tee "/Users/kaiden/Library/Application Support/RustDesk/config/RustDesk2.toml"
          enable-hwcodec = 'N'
          use-texture-render = 'N'
          allow-always-software-render = 'Y'
          allow-auto-disconnect = 'N'
          auto-disconnect-timeout = '0'
          image-quality = 'custom'
          custom-image-quality = '90'
          custom-fps = '60'
          codec-preference = 'vp9'
          enable-abr = 'Y'
          enable-udp-punch = 'Y'
          direct-server = 'Y'
          enable-lan-discovery = 'Y'
          allow-remove-wallpaper = 'N'
          allow-auto-accept = 'Y'
          RUSTDESK_CONFIG
          echo "=== Config file contents ==="
          cat "/Users/kaiden/Library/Application Support/RustDesk/config/RustDesk2.toml"
          echo "=== Setting permissions ==="
          sudo chown kaiden:staff "/Users/kaiden/Library/Application Support/RustDesk/config/RustDesk2.toml"
          echo "=== RustDesk configuration complete ==="

      - name: Start RustDesk Service
        run: |
          echo "=== Starting RustDesk ==="
          sudo -u kaiden open -a RustDesk
          echo "Waiting for RustDesk to start..."
          sleep 10
          echo "=== Checking RustDesk process ==="
          ps aux | grep -i rustdesk | grep -v grep || echo "RustDesk process check complete"
          echo "=== Getting RustDesk ID ==="
          if [ -f "/Users/kaiden/Library/Application Support/RustDesk/config/RustDesk.toml" ]; then
            cat "/Users/kaiden/Library/Application Support/RustDesk/config/RustDesk.toml"
          else
            echo "RustDesk.toml not yet created, ID will be shown on first run"
          fi
          echo "=== RustDesk started ==="

      # ========================================
      # STEP 8: Install and Configure Tailscale
      # ========================================
      - name: Install Tailscale
        run: |
          echo "=== Installing Tailscale ==="
          brew install tailscale
          echo "=== Verifying Tailscale installation ==="
          which tailscale
          tailscale version
          echo "=== Tailscale installed ==="

      - name: Start Tailscale
        env:
          TAILSCALE_AUTHKEY: ${{ secrets.TAILSCALE_AUTHKEY }}
        run: |
          echo "=== Starting Tailscale daemon ==="
          sudo tailscaled --state=/var/lib/tailscale/tailscaled.state --socket=/var/run/tailscale/tailscaled.sock &
          echo "Waiting for tailscaled..."
          sleep 5
          echo "=== Connecting to Tailscale network ==="
          sudo tailscale up --authkey="$TAILSCALE_AUTHKEY" --hostname=github-macos-runner
          echo "=== Tailscale status ==="
          tailscale status
          echo "=== Tailscale IP ==="
          tailscale ip -4
          echo "=== Tailscale connected ==="

      # ========================================
      # STEP 9: Display Connection Info
      # ========================================
      - name: Display Connection Information
        run: |
          echo ""
          echo "============================================"
          echo "    REMOTE DESKTOP CONNECTION INFO"
          echo "============================================"
          echo ""
          echo "=== Tailscale IP ==="
          TAILSCALE_IP=$(tailscale ip -4)
          echo "IP: $TAILSCALE_IP"
          echo ""
          echo "=== VNC Connection ==="
          echo "Address: vnc://$TAILSCALE_IP:5900"
          echo "Password: kaiden123"
          echo ""
          echo "=== RustDesk ==="
          echo "Look for RustDesk ID in the logs above or connect via Tailscale IP"
          echo ""
          echo "=== User Credentials ==="
          echo "Username: kaiden"
          echo "Password: kaiden123"
          echo ""
          echo "============================================"
          echo ""
          echo "=== Attempting to retrieve RustDesk ID ==="
          if [ -f "/Users/kaiden/Library/Application Support/RustDesk/config/RustDesk.toml" ]; then
            grep -i "id" "/Users/kaiden/Library/Application Support/RustDesk/config/RustDesk.toml" || echo "ID not in config"
          fi
          if [ -f "/Library/Application Support/RustDesk/config/RustDesk.toml" ]; then
            grep -i "id" "/Library/Application Support/RustDesk/config/RustDesk.toml" || echo "ID not in system config"
          fi

      # ========================================
      # STEP 10: Keep Session Alive
      # ========================================
      - name: Keep Session Alive
        run: |
          echo "=== Starting keep-alive loop ==="
          echo "Session will remain active for up to 6 hours"
          echo ""
          KEEPALIVE_LOG="/tmp/keepalive.log"
          START_TIME=$(date +%s)
          ITERATION=0
            while true; do
              ITERATION=$((ITERATION + 1))
              CURRENT_TIME=$(date +%s)
              ELAPSED=$(( (CURRENT_TIME - START_TIME) / 60 ))
              echo "$(date): Keep-alive iteration $ITERATION (${ELAPSED} minutes elapsed)" | tee -a $KEEPALIVE_LOG
              if [ $((ITERATION % 5)) -eq 0 ]; then
                echo "=== Service Health Check ===" | tee -a $KEEPALIVE_LOG
                if pgrep -f RustDesk; then
                  echo "RustDesk: RUNNING" | tee -a $KEEPALIVE_LOG
                else
                  echo "RustDesk: NOT RUNNING - Restarting..." | tee -a $KEEPALIVE_LOG
                  sudo -u kaiden open -a RustDesk
                fi
                if tailscale status; then
                  echo "Tailscale: CONNECTED" | tee -a $KEEPALIVE_LOG
                  tailscale ip -4 | tee -a $KEEPALIVE_LOG
                else
                  echo "Tailscale: DISCONNECTED" | tee -a $KEEPALIVE_LOG
                fi
                if pgrep -f ARDAgent; then
                  echo "ARD Agent: RUNNING" | tee -a $KEEPALIVE_LOG
                else
                  echo "ARD Agent: NOT RUNNING" | tee -a $KEEPALIVE_LOG
                fi
                if pgrep -f BetterDisplay; then
                  echo "BetterDisplay: RUNNING" | tee -a $KEEPALIVE_LOG
                else
                  echo "BetterDisplay: NOT RUNNING - Restarting..." | tee -a $KEEPALIVE_LOG
                  open "/Applications/BetterDisplay.app"
                fi
                echo "===========================" | tee -a $KEEPALIVE_LOG
              fi
              sleep 60
            done

