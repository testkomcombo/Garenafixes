name: macOS-Remote-Claude

on:
  workflow_dispatch:

jobs:
  macos-rdp:
    runs-on: macos-latest
    timeout-minutes: 3600

    steps:
      - name: Get macOS Version
        run: sw_vers

      - name: Create User with Full Admin
        run: |
          sudo dscl . -create /Users/kaiden
          sudo dscl . -create /Users/kaiden UserShell /bin/zsh
          sudo dscl . -create /Users/kaiden RealName "Kaiden"
          sudo dscl . -create /Users/kaiden UniqueID 1001
          sudo dscl . -create /Users/kaiden PrimaryGroupID 80
          sudo dscl . -create /Users/kaiden NFSHomeDirectory /Users/kaiden
          sudo dscl . -passwd /Users/kaiden "amaalik1"
          
          sudo dscl . -append /Groups/admin GroupMembership kaiden
          sudo dscl . -append /Groups/wheel GroupMembership kaiden
          sudo dscl . -append /Groups/com.apple.access_screensharing GroupMembership kaiden
          
          sudo createhomedir -c -u kaiden
          
          echo "kaiden ALL=(ALL) NOPASSWD: ALL" | sudo tee /etc/sudoers.d/kaiden
          sudo chmod 440 /etc/sudoers.d/kaiden

      - name: Fix TCC Permissions First
        run: |
          TCC_DB="/Library/Application Support/com.apple.TCC/TCC.db"
          
          # Screen Capture
          sudo sqlite3 "$TCC_DB" "INSERT OR REPLACE INTO access (service,client,client_type,auth_value,auth_reason,auth_version) VALUES ('kTCCServiceScreenCapture','com.apple.screensharing.agent',0,2,4,1);" 2>/dev/null || true
          sudo sqlite3 "$TCC_DB" "INSERT OR REPLACE INTO access (service,client,client_type,auth_value,auth_reason,auth_version) VALUES ('kTCCServiceScreenCapture','com.apple.RemoteDesktop.agent',0,2,4,1);" 2>/dev/null || true
          sudo sqlite3 "$TCC_DB" "INSERT OR REPLACE INTO access (service,client,client_type,auth_value,auth_reason,auth_version) VALUES ('kTCCServiceScreenCapture','/usr/libexec/screensharingd',1,2,4,1);" 2>/dev/null || true
          
          # Post Event
          sudo sqlite3 "$TCC_DB" "INSERT OR REPLACE INTO access (service,client,client_type,auth_value,auth_reason,auth_version) VALUES ('kTCCServicePostEvent','com.apple.screensharing.agent',0,2,4,1);" 2>/dev/null || true
          sudo sqlite3 "$TCC_DB" "INSERT OR REPLACE INTO access (service,client,client_type,auth_value,auth_reason,auth_version) VALUES ('kTCCServicePostEvent','/usr/libexec/screensharingd',1,2,4,1);" 2>/dev/null || true
          
          # Accessibility
          sudo sqlite3 "$TCC_DB" "INSERT OR REPLACE INTO access (service,client,client_type,auth_value,auth_reason,auth_version) VALUES ('kTCCServiceAccessibility','com.apple.screensharing.agent',0,2,4,1);" 2>/dev/null || true
          sudo sqlite3 "$TCC_DB" "INSERT OR REPLACE INTO access (service,client,client_type,auth_value,auth_reason,auth_version) VALUES ('kTCCServiceAccessibility','/usr/libexec/screensharingd',1,2,4,1);" 2>/dev/null || true
          
          # NoMachine TCC permissions
          sudo sqlite3 "$TCC_DB" "INSERT OR REPLACE INTO access (service,client,client_type,auth_value,auth_reason,auth_version) VALUES ('kTCCServiceScreenCapture','com.nomachine.nxnode',0,2,4,1);" 2>/dev/null || true
          sudo sqlite3 "$TCC_DB" "INSERT OR REPLACE INTO access (service,client,client_type,auth_value,auth_reason,auth_version) VALUES ('kTCCServiceAccessibility','com.nomachine.nxnode',0,2,4,1);" 2>/dev/null || true
          sudo sqlite3 "$TCC_DB" "INSERT OR REPLACE INTO access (service,client,client_type,auth_value,auth_reason,auth_version) VALUES ('kTCCServicePostEvent','com.nomachine.nxnode',0,2,4,1);" 2>/dev/null || true

      - name: Set Resolution
        run: |
          brew install displayplacer
          
          echo "=== Detecting display ID ==="
          DISPLAY_ID=$(displayplacer list 2>/dev/null | grep -E "^Persistent screen id:" | head -1 | sed 's/Persistent screen id: //')
          
          if [ -n "$DISPLAY_ID" ]; then
            echo "Detected display ID: $DISPLAY_ID"
            echo "Setting resolution to 1280x720 @ 60Hz..."
            if displayplacer "id:$DISPLAY_ID res:1280x720 hz:60 color_depth:7"; then
              echo "Resolution set successfully"
            else
              echo "Failed with detected ID, trying fallback id:1..."
              displayplacer "id:1 res:1280x720 hz:60 color_depth:7" 2>/dev/null || echo "Fallback also failed, continuing anyway"
            fi
          else
            echo "Could not detect display ID, using fallback id:1"
            displayplacer "id:1 res:1280x720 hz:60 color_depth:7" 2>/dev/null || echo "Fallback failed, continuing anyway"
          fi
          
          echo ""
          echo "=== Current display configuration ==="
          displayplacer list 2>/dev/null || true

      - name: Start VNC via ARD Kickstart
        run: |
          echo "=== Configuring Apple Remote Desktop with VNC ==="
          
          # Set VNC password file (encrypted format)
          echo "amaalik1" | sudo perl -we '
            $pw = <STDIN>;
            chomp $pw;
            @k = unpack "C*", pack "H*", "1734516E8BA8C5E2FF1C39567390ADCA";
            @p = unpack "C*", $pw;
            foreach (0..length($pw)-1) {
              $p[$_] ^= $k[$_];
            }
            print pack "C*", @p;
          ' | sudo dd of=/Library/Preferences/com.apple.VNCSettings.txt 2>/dev/null || true
          
          sudo chmod 400 /Library/Preferences/com.apple.VNCSettings.txt
          
          # Enable VNC in preferences
          sudo defaults write /Library/Preferences/com.apple.RemoteManagement VNCLegacyConnectionsEnabled -bool true
          sudo defaults write /Library/Preferences/com.apple.RemoteManagement ARD_AllLocalUsers -bool true
          sudo defaults write /Library/Preferences/com.apple.RemoteManagement ScreenSharingReqPermEnabled -bool false
          sudo defaults write /Library/Preferences/com.apple.RemoteManagement LoadRemoteManagementMenuExtra -bool false
          
          # Configure and start ARD with VNC using kickstart
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
            -activate \
            -configure \
            -access -on \
            -privs -all \
            -clientopts -setvnclegacy -vnclegacy yes \
            -clientopts -setvncpw -vncpw amaalik1 \
            -clientopts -setreqperm -reqperm no \
            -allowAccessFor -allUsers \
            -restart -agent -menu
          
          sleep 3
          
          # Try multiple methods to enable VNC on port 5900
          echo "=== Attempting to enable VNC on port 5900 ==="
          
          # Method 1: launchctl for screensharing
          echo "Method 1: launchctl screensharing service..."
          sudo launchctl enable system/com.apple.screensharing 2>/dev/null || true
          sudo launchctl bootstrap system /System/Library/LaunchDaemons/com.apple.screensharing.plist 2>/dev/null || true
          sudo launchctl kickstart -kp system/com.apple.screensharing 2>/dev/null || true
          sleep 2
          
          # Method 2: Direct load
          echo "Method 2: Direct load..."
          sudo launchctl load -w /System/Library/LaunchDaemons/com.apple.screensharing.plist 2>/dev/null || true
          sleep 2
          
          # Check if VNC is up
          if lsof -iTCP:5900 -sTCP:LISTEN 2>/dev/null | grep -q LISTEN; then
            echo "VNC is now listening on port 5900!"
          else
            echo "VNC port 5900 not available (macOS 15 SIP restriction)"
            echo "ARD on port 3283 should work as alternative"
          fi
          
          echo ""
          echo "=== Port status ==="
          echo "Port 5900 (VNC):"
          lsof -iTCP:5900 -sTCP:LISTEN 2>/dev/null || echo "  Not listening"
          echo "Port 3283 (ARD):"
          lsof -iTCP:3283 -sTCP:LISTEN 2>/dev/null || echo "  Not listening"

      - name: Install and Start NoMachine
        run: |
          echo "=== Installing NoMachine (NX) for low-latency remote desktop ==="
          
          brew install --cask nomachine
          
          sleep 5
          
          echo "=== Finding NoMachine installation ==="
          
          # Find nxserver binary
          NXSERVER=""
          for path in "/etc/NX/nxserver" "/usr/NX/bin/nxserver"; do
            if [ -x "$path" ] || [ -L "$path" ]; then
              NXSERVER="$path"
              echo "Found nxserver at: $NXSERVER"
              break
            fi
          done
          
          if [ -z "$NXSERVER" ]; then
            echo "ERROR: nxserver not found!"
            exit 1
          fi
          
          echo "NXSERVER=$NXSERVER" >> $GITHUB_ENV
          
          # NoMachine config locations
          NX_CFG_DIR="/Applications/NoMachine.app/Contents/Frameworks/etc"
          SERVER_CFG="$NX_CFG_DIR/server.cfg"
          NODE_CFG="$NX_CFG_DIR/node.cfg"
          NXD_CFG="$NX_CFG_DIR/nxd.cfg"
          
          echo "=== Configuring NoMachine for external connections ==="
          
          # Stop NoMachine first to apply config changes
          sudo "$NXSERVER" --shutdown 2>/dev/null || true
          sleep 2
          
          # Configure server.cfg - uncomment and set values properly
          if [ -f "$SERVER_CFG" ]; then
            echo "Modifying server config: $SERVER_CFG"
            sudo cp "$SERVER_CFG" "${SERVER_CFG}.bak"
            
            # Uncomment and set NXPort
            sudo sed -i '' 's/^#NXPort .*/NXPort 4000/' "$SERVER_CFG"
            sudo sed -i '' 's/^NXPort .*/NXPort 4000/' "$SERVER_CFG"
            
            # Uncomment and set NXTCPPort  
            sudo sed -i '' 's/^#NXTCPPort .*/NXTCPPort 4000/' "$SERVER_CFG"
            sudo sed -i '' 's/^NXTCPPort .*/NXTCPPort 4000/' "$SERVER_CFG"
            
            # Uncomment and set NXUDPPort
            sudo sed -i '' 's/^#NXUDPPort .*/NXUDPPort 4000/' "$SERVER_CFG"
            sudo sed -i '' 's/^NXUDPPort .*/NXUDPPort 4000/' "$SERVER_CFG"
            
            # Set accepted auth methods
            sudo sed -i '' 's/^#AcceptedAuthenticationMethods .*/AcceptedAuthenticationMethods all/' "$SERVER_CFG"
            sudo sed -i '' 's/^AcceptedAuthenticationMethods .*/AcceptedAuthenticationMethods all/' "$SERVER_CFG"
            
            # Enable network broadcast
            sudo sed -i '' 's/^#EnableNetworkBroadcast .*/EnableNetworkBroadcast 1/' "$SERVER_CFG"
            
            echo "Checking server.cfg NX port settings:"
            grep -E "^#?NX.*Port|^#?AcceptedAuth" "$SERVER_CFG" || true
          fi
          
          # Configure nxd.cfg for the nxd listener daemon
          if [ -f "$NXD_CFG" ]; then
            echo ""
            echo "Modifying nxd config: $NXD_CFG"
            sudo cp "$NXD_CFG" "${NXD_CFG}.bak"
            
            # Set nxd to listen on all interfaces
            sudo sed -i '' 's/^#NXDBindAddress .*/NXDBindAddress 0.0.0.0/' "$NXD_CFG"
            sudo sed -i '' 's/^NXDBindAddress .*/NXDBindAddress 0.0.0.0/' "$NXD_CFG"
            
            # Add if not present
            if ! grep -q "^NXDBindAddress" "$NXD_CFG"; then
              echo "NXDBindAddress 0.0.0.0" | sudo tee -a "$NXD_CFG"
            fi
            
            echo "Checking nxd.cfg:"
            grep -E "Bind|Port" "$NXD_CFG" | head -10 || true
          else
            echo "nxd.cfg not found at $NXD_CFG"
            # Try to find it
            find /Applications/NoMachine.app -name "*.cfg" 2>/dev/null | head -10
          fi
          
          # Configure node.cfg
          if [ -f "$NODE_CFG" ]; then
            echo ""
            echo "Modifying node config: $NODE_CFG"
            sudo cp "$NODE_CFG" "${NODE_CFG}.bak"
            
            # Uncomment and set NodeBind
            sudo sed -i '' 's/^#NodeBind .*/NodeBind 0.0.0.0/' "$NODE_CFG"
            sudo sed -i '' 's/^NodeBind .*/NodeBind 0.0.0.0/' "$NODE_CFG"
            
            # Uncomment and set DisplayServerBind
            sudo sed -i '' 's/^#DisplayServerBind .*/DisplayServerBind 0.0.0.0/' "$NODE_CFG"
            sudo sed -i '' 's/^DisplayServerBind .*/DisplayServerBind 0.0.0.0/' "$NODE_CFG"
            
            # Add if not present
            if ! grep -q "^NodeBind" "$NODE_CFG"; then
              echo "NodeBind 0.0.0.0" | sudo tee -a "$NODE_CFG"
            fi
            if ! grep -q "^DisplayServerBind" "$NODE_CFG"; then
              echo "DisplayServerBind 0.0.0.0" | sudo tee -a "$NODE_CFG"
            fi
          fi
          
          echo ""
          echo "=== Starting NoMachine server ==="
          sudo "$NXSERVER" --startup
          sleep 5
          
          echo ""
          echo "=== NoMachine server status ==="
          sudo "$NXSERVER" --status || true
          
          echo ""
          echo "=== Checking NoMachine ports ==="
          echo "Port 4000 (NX protocol):"
          if lsof -iTCP:4000 -sTCP:LISTEN 2>/dev/null | grep -q LISTEN; then
            echo "  LISTENING!"
            lsof -iTCP:4000 -sTCP:LISTEN
          else
            echo "  Not listening on 4000"
            echo ""
            echo "  Checking all NX listening ports:"
            lsof -i -P 2>/dev/null | grep -iE "nx|nomachine" | grep LISTEN || echo "    None found"
          fi
          
          echo ""
          echo "=== All NoMachine processes ==="
          ps aux | grep -iE "nx|nomachine" | grep -v grep || echo "No NX processes"

      - name: Optimize Network
        run: |
          sudo sysctl -w net.inet.tcp.sendspace=2097152 || true
          sudo sysctl -w net.inet.tcp.recvspace=2097152 || true
          sudo sysctl -w net.inet.tcp.delayed_ack=0 || true
          sudo sysctl -w net.inet.tcp.mssdflt=1460 || true
          sudo sysctl -w kern.ipc.somaxconn=8192 || true

      - name: Install Firefox and Create Shortcuts
        run: |
          brew install --cask firefox 2>/dev/null || true
          
          sudo mkdir -p /Users/kaiden/Desktop
          sudo ln -sf "/Applications/Firefox.app" "/Users/kaiden/Desktop/Firefox" 2>/dev/null || true
          sudo ln -sf "/Applications/Safari.app" "/Users/kaiden/Desktop/Safari" 2>/dev/null || true
          sudo chown -R kaiden:staff /Users/kaiden/Desktop

      - name: Install Tailscale
        run: brew install tailscale

      - name: Start Tailscale
        run: |
          sudo mkdir -p /var/lib/tailscale
          sudo mkdir -p /var/run/tailscale
          
          sudo /opt/homebrew/opt/tailscale/bin/tailscaled \
            --state=/var/lib/tailscale/tailscaled.state \
            --socket=/var/run/tailscale/tailscaled.sock \
            > /tmp/tailscaled.log 2>&1 &
          
          sleep 8
          
          sudo /opt/homebrew/opt/tailscale/bin/tailscale \
            --socket=/var/run/tailscale/tailscaled.sock \
            up \
            --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} \
            --hostname=macos-runner-${{ github.run_id }}
          
          sleep 5
          
          TS_IP=$(sudo /opt/homebrew/opt/tailscale/bin/tailscale --socket=/var/run/tailscale/tailscaled.sock ip -4)
          echo "TAILSCALE_IP=$TS_IP" >> $GITHUB_ENV
          
          echo ""
          echo "=== Tailscale Network Diagnostics ==="
          sudo /opt/homebrew/opt/tailscale/bin/tailscale --socket=/var/run/tailscale/tailscaled.sock netcheck || true

      - name: Final Check and Status
        run: |
          echo ""
          echo "============================================"
          echo "       FINAL REMOTE ACCESS STATUS           "
          echo "============================================"
          echo ""
          
          echo "=== NoMachine (NX) Status ==="
          if lsof -iTCP:4000 -sTCP:LISTEN 2>/dev/null | grep -q LISTEN; then
            echo "[OK] NoMachine is running on port 4000"
            lsof -iTCP:4000 -sTCP:LISTEN
          else
            echo "[INFO] NoMachine port 4000 not listening externally"
            echo "       NX may be using SSH tunneling mode on port 22"
            lsof -i -P 2>/dev/null | grep -iE "nx" | grep LISTEN | head -5 || true
          fi
          
          echo ""
          echo "=== VNC Status ==="
          if lsof -iTCP:5900 -sTCP:LISTEN 2>/dev/null | grep -q LISTEN; then
            echo "[OK] VNC is running on port 5900"
            lsof -i :5900
          else
            echo "[INFO] VNC port 5900 not available (macOS 15 SIP)"
          fi
          
          echo ""
          echo "=== ARD Status (Apple Remote Desktop) ==="
          if lsof -iTCP:3283 -sTCP:LISTEN 2>/dev/null | grep -q LISTEN; then
            echo "[OK] ARD is running on port 3283"
            lsof -i :3283
          else
            echo "[WARN] ARD port 3283 not available"
          fi
          
          echo ""
          echo "=== All Listening Ports ==="
          lsof -i -P 2>/dev/null | grep LISTEN | head -30

      - name: Display Connection Info
        run: |
          echo ""
          echo "============================================"
          echo "        macOS REMOTE ACCESS                 "
          echo "============================================"
          echo ""
          
          # Check what is available
          NX_4000=false
          VNC_OK=false
          ARD_OK=false
          
          if lsof -iTCP:4000 -sTCP:LISTEN 2>/dev/null | grep -q LISTEN; then
            NX_4000=true
          fi
          if lsof -iTCP:5900 -sTCP:LISTEN 2>/dev/null | grep -q LISTEN; then
            VNC_OK=true
          fi
          if lsof -iTCP:3283 -sTCP:LISTEN 2>/dev/null | grep -q LISTEN; then
            ARD_OK=true
          fi
          
          echo "NOMACHINE (Best Performance)"
          echo "--------------------------------------------"
          if [ "$NX_4000" = "true" ]; then
            echo "  Status:    AVAILABLE on port 4000"
            echo "  Address:   $TAILSCALE_IP:4000"
          else
            echo "  Status:    Using SSH tunnel mode"
            echo "  Address:   $TAILSCALE_IP (via SSH)"
          fi
          echo "  Username:  kaiden"
          echo "  Password:  amaalik1"
          echo ""
          echo "  To connect:"
          echo "    1. Download NoMachine from https://nomachine.com"
          echo "    2. Create new connection"
          echo "    3. Host: $TAILSCALE_IP  Port: 4000 (or use SSH)"
          echo "    4. Login: kaiden / amaalik1"
          
          echo ""
          echo "VNC (Standard)"
          echo "--------------------------------------------"
          if [ "$VNC_OK" = "true" ]; then
            echo "  Status:    AVAILABLE"
            echo "  Address:   $TAILSCALE_IP:5900"
            echo "  Password:  amaalik1"
          else
            echo "  Status:    NOT AVAILABLE (macOS 15 restriction)"
          fi
          
          echo ""
          echo "ARD (Apple Remote Desktop) - RECOMMENDED"
          echo "--------------------------------------------"
          if [ "$ARD_OK" = "true" ]; then
            echo "  Status:    AVAILABLE"
            echo "  Address:   $TAILSCALE_IP:3283"
            echo "  Username:  kaiden"
            echo "  Password:  amaalik1"
            echo ""
            echo "  Compatible clients:"
            echo "    - Apple Remote Desktop (Mac App Store)"
            echo "    - Screens 5 (Mac/iOS) - RECOMMENDED"
            echo "    - Royal TSX (Mac)"
            echo "    - Jump Desktop (Mac/iOS/Windows)"
          else
            echo "  Status:    NOT AVAILABLE"
          fi
          
          echo ""
          echo "============================================"
          echo "  USER CREDENTIALS                          "
          echo "============================================"
          echo ""
          echo "  Username:   kaiden"
          echo "  Password:   amaalik1"
          echo "  Sudo:       No password required"
          echo ""
          echo "===============================
